<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Watch Episode</title>

<!-- Plyr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.css" />

<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #0d1117;
    color: #fff;
  }
  .container {
    max-width: 900px;
    margin: 20px auto;
    padding: 0 15px;
  }
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }
  .header h1 {
    font-size: 1.2em;
    margin: 0;
  }
  .back-btn {
    color: #23c6ed;
    text-decoration: none;
    font-weight: bold;
  }
  .plyr__video-embed {
    border-radius: 10px;
    overflow: hidden;
  }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <a href="#" class="back-btn" id="backBtn">‚Üê Back</a>
    <h1 id="episodeTitle">Loading...</h1>
  </div>

  <video id="player" controls crossorigin playsinline></video>
</div>

<!-- Plyr JS -->
<script src="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.min.js"></script>
<!-- HLS.js for MP4/HLS adaptive streaming -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.1/dist/hls.min.js"></script>

<script>
(async function() {
  const params = new URLSearchParams(window.location.search);
  const slug = params.get('series');
  const season = params.get('season');
  const epNum = params.get('ep');

  const container = document.querySelector('.container');
  const episodeTitleEl = document.getElementById('episodeTitle');
  const backBtn = document.getElementById('backBtn');

  if (!slug || !season || !epNum) {
    container.innerHTML = '<div style="padding:50px;text-align:center;color:#ccc;">Invalid episode URL</div>';
    return;
  }

  backBtn.href = `series.html?series=${slug}&season=${season}`;

  // Load episode JSON
  const jsonFile = `episode-data/${slug}-s${season}.json`;
  try {
    const res = await fetch(jsonFile);
    if (!res.ok) throw new Error('JSON not found');
    const episodes = await res.json();
    const ep = episodes.find(e => String(e.ep) === String(epNum));
    if (!ep || !ep.watch3) {
      container.innerHTML = '<div style="padding:50px;text-align:center;color:#ccc;">Video not available</div>';
      return;
    }

    episodeTitleEl.textContent = ep.title || `Episode ${ep.ep}`;

    const video = document.getElementById('player');

    // Initialize Plyr
    const player = new Plyr(video, {
      controls: ['play', 'progress', 'current-time', 'mute', 'volume', 'settings', 'fullscreen'],
      settings: ['quality', 'speed', 'loop'],
      autoplay: false,
    });

    // Check if HLS or MP4
    const sourceURL = ep.watch3;
    if (Hls.isSupported() && sourceURL.endsWith('.m3u8')) {
      const hls = new Hls();
      hls.loadSource(sourceURL);
      hls.attachMedia(video);
      hls.on(Hls.Events.MANIFEST_PARSED, function() {
        player.play();
      });

      // Set quality options from HLS levels
      hls.on(Hls.Events.LEVEL_SWITCHING, (event, data) => {
        const level = hls.levels[data.level];
        console.log('Switching quality to', level.height);
      });

      // Audio tracks
      hls.on(Hls.Events.AUDIO_TRACK_SWITCHED, (event, data) => {
        console.log('Audio track switched to', hls.audioTracks[data.id].name);
      });

    } else {
      // Fallback for MP4
      player.source = {
        type: 'video',
        title: ep.title || `Episode ${ep.ep}`,
        sources: [
          {
            src: sourceURL,
            type: 'video/mp4',
            size: 720
          }
        ]
      };
    }

  } catch (err) {
    container.innerHTML = `<div style="padding:50px;text-align:center;color:#ccc;">Error loading episode: ${err.message}</div>`;
  }
})();
</script>

</body>
</html>
